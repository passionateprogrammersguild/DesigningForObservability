<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Designing for Observability</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/white.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
		<style>
			div.code {
				width: -moz-fit-content;
  				width: fit-content;				
				height: fit-content;
				height: -moz-fit-content
			}
			code {
				width: -moz-fit-content;
  				width: fit-content;	
				height: fit-content;
				height: -moz-fit-content
			}
		</style>
	</head>
	<body>
		<div>
			<!-- Logo goes here-->
			<img src="img/logo.png" height="50" widtrh="50" alt="Suddath logo"/>
		</div>
		<div class="reveal">
			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Designing for Observability </h1>
					<h3>An exercise with Microsoft Azure</h3>
					<aside class="notes">
						Welcome and thank you for attending this talk.  I am super-excited to share this material with you.  How many people are practicing monitoring, measureing system health and observability in their systems today?
	 				</aside>
				</section>

				<!--Introduction section -->
				<section>
					<section>
						<div>
							<img src="img/me.jpg" alt="Picture of Michael Mann">
						</div>

						<p>
							Hi, I'm Michael Mann. I am the Technical Lead for the Moving and Logistics Division at Suddath. Suddath is a Transportation and Logistics company that has been in business for over 100 years.
						</p>
					</section>

					<section data-markdown>
						<script type="text/template">
							![Alt text](img/organization.png "Organizational Structure")
						</script>
					</section>
	
					<section data-markdown>
						<script type="text/template">
							### Suddath Technology Landscape
							- Cloud first partnered with [Microsoft Azure](https://portal.azure.com)
							- [Azure Devops](https://dev.azure.com/) for source control and CICD
							- Web Applications - [Angular Spa](https://angular.io/) w/API's in C#
							- Desktop Applications - [WinUI3](https://docs.microsoft.com/en-us/windows/apps/winui/winui3/) with [Realm](https://realm.io/) for local sync and API's in C#
							- Mobile Applications - [Xamarin Forms](https://docs.microsoft.com/en-us/xamarin/get-started/what-is-xamarin-forms) with [Realm](https://realm.io/) for local sync and API's in C# 						
						</script>
					</section>
				</section>				
				
				
				<section data-markdown>
					<script type="text/template">						
						### What we will cover in this talk
						- Understand the terms Health, Monitoring and Observability
						- Review the Architecture of a sytem in the context of health, monitoring, and observability
						- Examine the tools available in the Azure ecosystem
						- Apply what we have learned to an existing system
					</script>
				</section>
				

				<section>
					<section data-background="img/birdwatching.jpg">
						<h2 style="color:white;">Definition of Terms</h2>
					</section>
					
					<section data-markdown>
						<script type="text/template">
							### System Health
														
							According the the [World Health Organization](https://www.who.int/about/governance/constitution), health is defined as a state of complete physical, mental and social well-being and not merely the absence of disease or infirmity.
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							### Monitoring
														
							From the [Google SRE book](https://sre.google/sre-book/monitoring-distributed-systems/) monitoring is defined as collecting, processing, aggregating, and displaying real-time quantitative data about a system, such as query counts and types, error counts and types, processing times, and server lifetimes.
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							### Observability
														
							According to [Honeycomb](https://docs.honeycomb.io/getting-started/learning-about-observability/) observability is about being able to ask arbitrary questions about your environment without having to know ahead of time what you wanted to ask.
						</script>
					</section>
				</section>					
				
				<section>
					
					<section data-markdown>
						<script type="text/template">
							### Let's look at a running system
						</script>
					</section>
					
					<section data-markdown>
						<script type="text/template">
							### Estimator
														
							[Estimator &#174;](https://suddath.com/news/suddath-wins-digital-edge-50-international-technology-award/) is an application primarilary used by Salespeople to estimate business moves.  The application is designed to be mobile first such that Salespeople can perform an estimate on-site.
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							### High-level components
														
							- Desktop application
							- Web Application for managing rates
							- Web Application for managing  custom inventory
							- Web properties hosted in Microsoft Azure
							- Authentication / Authorization partner is Auth0
							- Documents stored in Azure Blob Storage
							- Hosted Sql Azure database
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							#### Estimator Desktop Application
							![Alt text](img/estimator-architecture.png "Estimator Architecture")
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							#### Estimator Rate Management Web Application
							![Alt text](img/estimator-ratemanagement.png "Estimator Rate Management Web Application Architecture")
						</script>						
					</section>

					<section data-markdown>
						<script type="text/template">
							#### Estimator Inventory Management Web Application
							![Alt text](img/estimator-inventorymanagement.png "Estimator Inventory Management Web Application Architecture")
						</script>						
					</section>					
				</section>

				<section>
					<section data-markdown>
						<script type="text/template">
							### [Health checks in ASP.NET Core](https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks?view=aspnetcore-6.0)

							- Health probes can be used by container orchestrators and load balancers to check an app's status.
							- Use of memory, disk, and other physical server resources can be monitored for healthy status.
							- Health checks can test an app's dependencies, such as databases and external service endpoints, to confirm availability and normal functioning.
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							### System Health
														
							According the the [World Health Organization](https://www.who.int/about/governance/constitution), health is defined as a state of complete physical, mental and social well-being and not merely the absence of disease or infirmity.
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							#### Exercise #1 - An outside in approach to health
							![Alt text](img/estimator-architecture.png "Estimator Architecture")
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">							
							![Alt text](img/estimator-architecture-health.png "Estimator Architecture")
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							#### Exercise #2 - An outside in approach to health
							![Alt text](img/estimator-ratemanagement.png "Estimator Rate Management Web Application Architecture")
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							![Alt text](img/estimator-ratemanagement-health.png "Estimator Rate Management Web Application Architecture")
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							#### Exercise #3 - An outside in approach to health
							![Alt text](img/estimator-inventorymanagement.png "Estimator Inventory Management Web Application Architecture")
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							![Alt text](img/estimator-inventorymanagement-health.png "Estimator Inventory Management Web Application Architecture")
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							### Tools to add [Health Checks](https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks?view=aspnetcore-6.0) to an existing system
														
							- [Microsoft.Extensions.Diagnostics.HealthChecks](https://www.nuget.org/packages/Microsoft.Extensions.Diagnostics.HealthChecks)
							- [AspNetCore.HealthChecks.UI.Client](https://www.nuget.org/packages/AspNetCore.HealthChecks.UI.Client)
							- [AspNetCore.HealthChecks.SqlServer](https://www.nuget.org/packages/AspNetCore.HealthChecks.SqlServer)
							- [AspNetCore.HealthChecks.AzureStorage](https://www.nuget.org/packages/AspNetCore.HealthChecks.AzureStorage)
							- [Create your own HealthCheck](https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks?view=aspnetcore-6.0#create-health-checks)
						</script>
					</section>
				</section>

				<section>
					<section data-markdown>
						<script type="text/template">
							### Layering in HealthChecks
														
							![Alt text](img/healthchecks-add.png "Adding HealthChecks to csproj")
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							### Adding to Startup.cs
														
							![Alt text](img/healthchecks-startup.png "Adding HealthChecks to Startup")
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							### Turning on the HealthCheck endpoint in Azure
														
							![Alt text](img/healthchecks-enable.png "Enable HealthChecks on an Azure Resource")
						</script>
					</section>
				</section>

				<section>
					<section data-markdown>
						<script type="text/template">
							### HealthCheck endpoints
							![Alt text](img/healthchecks-endpoint.png "HealthCheck Endpoint Example")
						</script>
					</section>

					<section>						
							<h3><a href="https://github.com/Xabaril/AspNetCore.Diagnostics.HealthChecks/blob/master/doc/webhooks.md">Configuring WebHooks</a></h3>
							<div class="code">
								<pre>
								<code data-trim data-noescape>
								setup
								.AddWebhookNotification("webhook1",
									uri: "status/200?code=ax3rt56s", 
									payload: "{ message: \"Webhook report for [[LIVENESS]]: [[FAILURE]] - Description: [[DESCRIPTIONS]]\"}",
									restorePayload: "{ message: \"[[LIVENESS]] is back to life\"}",
									shouldNotifyFunc: (livenessName, report) => DateTime.UtcNow.Hour >= 8 && DateTime.UtcNow.Hour <= 23
									customMessageFunc: (livenessName, report) =>
									{
										var failing = report.Entries.Where(e => e.Value.Status == UIHealthStatus.Unhealthy);
										return $"{failing.Count()} healthchecks are failing";
									},
									customDescriptionFunc: (livenessName, report) =>
									{
										var failing = report.Entries.Where(e => e.Value.Status == UIHealthStatus.Unhealthy);
										return $"HealthChecks with names {string.Join("/", failing.Select(f => f.Key))} are failing";
									});
								</code>
								</pre>
							</div>
					</section>

					<section data-markdown>
						<script type="text/template">
							### [A UI for HealthChecks](https://github.com/Xabaril/AspNetCore.Diagnostics.HealthChecks#HealthCheckUI)
							![Alt text](img/healthcheck-ui.png "HealthCheck UI")
						</script>
					</section>

					<section>						
						<h3>Incorporating HealthCheck UI</a></h3>
						<div class="code">
							<pre>
							<code data-trim data-noescape>
								using HealthChecks.UI.Core;
								using HealthChecks.UI.InMemory.Storage;

								public class Startup
								{
									public void ConfigureServices(IServiceCollection services)
									{
										services
											.AddHealthChecksUI()
											.AddInMemoryStorage();
									}

									public void Configure(IApplicationBuilder app, IHostingEnvironment env)
									{
										app
											.UseRouting()
											.UseEndpoints(config => config.MapHealthChecksUI());
									}
								}
							</code>
							</pre>
						</div>
					</section>
				</section>

				<section>
					<section data-markdown>
						<script type="text/template">
							## Example Custom HealthCheck
						</script>
					</section>

					<section>						
						<h3>Implement <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.diagnostics.healthchecks.ihealthcheck?view=dotnet-plat-ext-6.0">IHealthCheck</a></h3>
						<div class="code">
							<pre>
							<code data-trim data-noescape>
						public async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context, 
																					     CancellationToken cancellationToken = default)
						{
							try {
								if (await _authorizationService.Authorize() is FailedResponse failedAuthResponse)
								{
									throw failedAuthResponse.GetException();
								}											
								return HealthCheckResult.Healthy();
							} catch(Exception ex) {
								return HealthCheckResult.Degraded();
							}
						}
							</code>
							</pre>
						</div>
					</section>
				</section>
				<section>
					<section data-markdown>
						<script type="text/template">
							### [Monitoring in Azure with Application Insights](https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview)

							Application Insights helps development teams understand app performance and usage.
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### Application Insights Monitors

							- Request rates, response times, and failure rates
							- Dependency rates, response times, and failure rates
							- Exceptions
							- Diagnostic trace logs from apps
							- Custom events and metrics in client or server code that track business events
							- Performance counters from Windows or Linux server machines, such as CPU, memory, and network usage
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							### [Application Insights SDK](https://docs.microsoft.com/en-us/azure/azure-monitor/app/asp-net-core)

							- TelemetryClient - Client for the App Insights SDK
							- TelemetryInitializer - Enriches telemetry with additional information
							- TelemetryProcessor - Enables the ability to discard telemetry to increase signal
						</script>
					</section>
				</section>

				<section>
					<section data-markdown>
						<script type="text/template">
							### [TelemetryClient API](https://docs.microsoft.com/en-us/azure/azure-monitor/app/api-custom-events-metrics)

							| Method | Used For |
							| ----------- | ----------- |
							| TrackPageView | Pages, screens, blades, or forms. |
							| TrackEvent | User actions and other events. Used to track user behavior or to monitor performance. | 
							| GetMetric | Zero and multidimensional metrics, centrally configured aggregation, C# only. | 							
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							| Method | Used For |
							| ----------- | ----------- |
							| TrackMetric | Performance measurements such as queue lengths not related to specific events. | 
							| TrackException | Logging exceptions for diagnosis. Trace where they occur in relation to other events and examine stack traces. |
							| TrackRequest | Logging the frequency and duration of server requests for performance analysis. |							
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							| Method | Used For |
							| ----------- | ----------- |
							| TrackTrace | Resource Diagnostic log messages. You can also capture third-party logs. |
							| TrackDependency | Logging the duration and frequency of calls to external components that your app depends on. |
						</script>
					</section>
				</section>

				<section>
					<section data-markdown>
						<script type="text/template">
							### Tools to add [Monitoring](https://docs.microsoft.com/en-us/azure/azure-monitor/app/asp-net-core) to an existing system
														
							- [Microsoft.ApplicationInsights.AspNetCore](https://www.nuget.org/packages/Microsoft.ApplicationInsights/)
							- [Serilog.Sinks.ApplicationInsights](https://www.nuget.org/packages/Serilog.Sinks.ApplicationInsights)							
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							### Layering in Monitoring
														
							![Alt text](img/monitoring-add.png "Adding Monitoring to csproj")
						</script>
					</section>

					<section>
						<h3>Adding to Startup.cs</h3>
						<div class="code">
							<pre>
							<code data-trim data-noescape>
								// This method gets called by the runtime. Use this method to add services to the container.
								public void ConfigureServices(IServiceCollection services)
								{
									// The following line enables Application Insights telemetry collection.
									services.AddApplicationInsightsTelemetry();

									// This code adds other services for your application.
									services.AddMvc();
								}
							</code>
							</pre>
						</div>
					</section>

					<section data-markdown>
						<script type="text/template">
							### Don't Forget the Connection String
														
							![Alt text](img/instrumentationkey.png "The App Insights Connection String and instrumentationkey")
						</script>
					</section>
							
					<section>
						<h3>Local Testing of Monitoring</h3>
						<div class="code">
							<pre>
							<code data-trim data-noescape>
								{
									"ApplicationInsights": {
									  "ConnectionString" : "Copy connection string from Application Insights Resource Overview"
									},
									"Logging": {
									  "LogLevel": {
										"Default": "Warning"
									  }
									}
								  }
							</code>
							</pre>
						</div>
					</section>
				</section>
				
				<section>
					<section data-markdown>
						<script type="text/template">
							#### Monitoring Exercise - TelemetryClient
							<img src="img/mobile-sync.png" alt="Mobile Sync Without Telemetry" />					
						</script>
					</section>


					<section data-markdown>
						<script type="text/template">
							#### App Insights Monitoring with no changes
							<img src="img/mobile-sync-telemetry-nochanges.png" alt="Mobile Sync Simple Telemetry" />					
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							#### App Insights Monitoring with an exception
							<img src="img/mobile-sync-telemetry-nochanges-exception.png" alt="Mobile Sync Simple Telemetry with an exception" />					
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							#### App Insights Monitoring with TelemetryClient Logging the exception
							<img src="img/mobile-sync-telemetry-telemetryclient-exception.png" alt="Mobile Sync Simple Telemetry with TelemetryClient Logging the exception" />					
						</script>
					</section>
				</section>

				<section>
					<section>
						<h3>Adding the Logged in User with a TelemetryInitializer</h3>
						<div class="code">
							<pre>
							<code data-trim data-noescape>
								protected override void OnInitializeTelemetry(HttpContext platformContext, 
								RequestTelemetry? requestTelemetry, ITelemetry telemetry)
							{
								if (platformContext?.User?.Identity?.IsAuthenticated != true)
									return;
					
								if (requestTelemetry != null)
								{
									requestTelemetry.Context.User.AuthenticatedUserId = platformContext.User.TelemetryUserId();
								}
							}
							</code>
							</pre>
						</div>
					</section>

					<section data-markdown>
						<script type="text/template">
							#### App Insights Monitoring with TelemetryInitializer
							<img src="img/mobile-sync-telemetry-telemetryinitializer.png" alt="Mobile Sync Simple TelemetryInitializer add Logged in User" />					
						</script>
					</section>
				</section>

				<section>
					<section data-markdown>
						<script type="text/template">
							#### Adding Custom Events and Metrics with TelemetryClient - 1
							<img src="img/mobile-sync-telemetry-customeventsandmetrics-code-1.png" alt="Mobile Sync Adding Custom Events and Metrics Page 1" />					
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							#### Adding Custom Events and Metrics with TelemetryClient - 2
							<img src="img/mobile-sync-telemetry-customeventsandmetrics-code-2.png" alt="Mobile Sync Adding Custom Events and Metrics Page 2" />					
						</script>
					</section>
					
					<section data-markdown>
						<script type="text/template">
							#### App Insights Monitoring with Custom Events and Metrics
							<img src="img/mobile-sync-telemetry-customeventsandmetrics-telemetry.png" alt="Mobile Sync App Insights Custom Events and Metrics" />					
						</script>
					</section>
				</section>

				<section>
					<section data-markdown>
						<script type="text/template">
							#### Filtering Telemetry Output with ITelemetryProcessor - 1
							<img src="img/mobile-sync-telemetry-telemetryprocessor-code-1.png" alt="Mobile Sync TelemetryProcessor Example Code Page 1" />					
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							#### Filtering Telemetry Output with ITelemetryProcessor - 2
							<img src="img/mobile-sync-telemetry-telemetryprocessor-code-2.png" alt="Mobile Sync TelemetryProcessor Example Code Page 2" />					
						</script>
					</section>										
				</section>

				<section>
					<section data-markdown>
						<script type="text/template">
							### Observability in Azure with [Kusto](https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/)
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							### Kusto Query Language (KQL)
							Kusto Query Language is a powerful tool to explore your data and discover patterns, identify anomalies and outliers, create statistical modeling, and more. The query uses schema entities that are organized in a hierarchy similar to SQL's: databases, tables, and columns.							
						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							#### Sample Kusto Queries
							<img src="img/canned-kql-queries.png" alt="Get started with sample Kusto queries" />					
						</script>
					</section>
				</section>

				<section data-markdown>
					<script type="text/template">
						### [Azure Monitoring Alerts](https://docs.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-overview) an Exercise for the audience							
					</script>
				</section>
			
				<section>
					<h1>Thank you</h2>
					<div>							
						<span><a href="mailto:mmann2943@gmail.com">mmann2943@gmail.com</a></span>
						<span><a href="https://github.com/passionateprogrammersguild/DesigningForObservability">passionateprogrammersguild on github</a></span>
					</div>
				</section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
